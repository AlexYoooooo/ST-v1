# Parser

## About
The parser is a program that used to decode the query.

The PC will send a query (instruction file) to the hardware that contains information about the speed, direction and distance of the motor. The instruction can be nested and looped.

The parser program in the hardware (the MCU) will decode the query, then send command to motor (control the direction) and timer (control the speed).

## The files

parser-orginal.c shows how the parser program work in PC environment. Please compile this c program using gcc compiler. To discover this program, read the command and try modify the step[] array.

parser-eventdriver.c is a modified version of the parser. In practical, the MCU is event driven (the MCU drives the motor at t1, sets the timer and waits for t, then drives the motor again). This code will be embedded in the MCU's program.

test.c is a testbench used to verify the parser-eventdriver.c. Compile and run this code using gcc, it sould give you the similar output like parser-orginal.c.

sim.c is a program used to simulate the query output on PC. Please compile this program, used this program to verify your query before upload your query to the MCU. For instruction of this program, refer the comment in this c file.

## The query

Assume the command given by PC is:
```5+1056,2-234,7(,3+444,7),3(,2(,2-233,4+20000,2),5-3333,2),0(,1+11,0)```

Format of the command: CDT,CDT,CDT...

C: Unsigned 16-bit: Counter, repeat this command for C times (actual execute count = C + 1)

D: 1-bit: Forward direction = 1; Backward direction = 0

T: Unsigned 15-bit: Wait for T cycles before next instruction

If CT = 0x8000: Enter a loop

If CT = 0x0000: Exit a loop

___For example:___

5+1056: Run forwards for 6 times, interval between each run = 1056 (speed is 1/1056 unit distance pre unit time)

5+1056,2-234: Run forwards for 6 times, interval between each run = 1056; then, Run backwards for 3 times, interval between each run = 234

2(,5+1056,2): Run forwards for 6 times, interval between each run = 1056. Repeat this for 2 more times. (total execution count = 6 * 3 = 18)

7(,5+1056,2-234,7): Run forwards for 6 times, interval between each run = 1056; then, Run backwards for 3 times, interval between each run = 234. Then, repeat this for 7 more times

65535(,5+1056,2-234,65535): Run forwards for 6 times, interval between each run = 1056; then, Run backwards for 3 times, interval between each run = 234. Repeat this forever

For the query ```5+1056,2-234,7(,3+444,7),3(,2(,2-233,4+20000,2),5-3333,2),0(,1+11,0)```, we can trade it like a 32-bit wide array:
```C
//See parser-orginal.c
	uint32_t step[] = {
		(5<<16)|	(1<<15)|	1056,
		(2<<16)|	(0<<15)|	234,
		(7<<16)|	(1<<15)|	0,
		(3<<16)|	(1<<15)|	444,
		(7<<16)|	(0<<15)|	0,
		(3<<16)|	(1<<15)|	0,
		(2<<16)|	(1<<15)|	0,
		(2<<16)|	(0<<15)|	233,
		(4<<16)|	(1<<15)|	20000,
		(2<<16)|	(0<<15)|	0,
		(5<<16)|	(0<<15)|	3333,
		(3<<16)|	(0<<15)|	0,
		//Append a dead loop to prevent instruction parser buffer overflow
		(65535<<16)|	(1<<15)|	0,
		(1<<16)|	(1<<15)|	11,
		(65535<<16)|	(0<<15)|	0
	};
  ```
  
  Since the MCU is 8-bit based, we can use this code to encode the above array into 8-bit wide array:
  ```C
  for (unsigned int i = 0; i < sizeof(step) >> 2; i++) {
		query[4*i+0] = (step[i]>>24) & 0xFF;
		query[4*i+1] = (step[i]>>16) & 0xFF;
		query[4*i+2] = (step[i]>>8)  & 0xFF;
		query[4*i+3] = (step[i]>>0)  & 0xFF;
	}
  ```
  
  The following hexdicimal coded query is generated using the above array, and it will be send to the MCU:
  
  ```0000000000058420000200ea00078000000381bc000700000003800000028000000200e90004ce200002000000050d0500030000ffff80000001800bffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004003400340034```
  
 __Notice: The last 8 bytes are used to indecates the beginning of the query for each motor__
 
There is 4 axis, the W, X, Y, Z axis. The 8th last and the 7th lastest bytes show the beginning of the instruction for W-axis in the query; the 6th and 5th latest bytes show the beginning of the instruction for X-axis in the query; the 4th and 3rd lateset bytes for Y-axis; the 2nd and 1st lateset bytes for Z-axis.

RUn the sim.c to simulate the above query, the following is the part of the output, some lines are skipped:
```

=== AXIS-W SIMULATION ===
+++ Event 0, time: 0, motor location: 1 +++
+++ Event 1, time: 1056, motor location: 2 +++
+++ Event 2, time: 2112, motor location: 3 +++
+++ Event 3, time: 3168, motor location: 4 +++
+++ Event 4, time: 4224, motor location: 5 +++
+++ Event 5, time: 5280, motor location: 6 +++
+++ Event 6, time: 6336, motor location: 5 +++
+++ Event 7, time: 6570, motor location: 4 +++
+++ Event 8, time: 6804, motor location: 3 +++
(Some lines in the simulation output are skipped)
+++ Event 161, time: 1309626, motor location: 36 +++
+++ Event 162, time: 1309637, motor location: 37 +++
### Dead loop: go back to event 161 ###

=== AXIS-X SIMULATION ===
+++ Event 0, time: 0, motor location: 1 +++
+++ Event 1, time: 11, motor location: 2 +++
### Dead loop: go back to event 0 ###

=== AXIS-Y SIMULATION ===
+++ Event 0, time: 0, motor location: 1 +++
+++ Event 1, time: 11, motor location: 2 +++
### Dead loop: go back to event 0 ###

=== AXIS-Z SIMULATION ===
+++ Event 0, time: 0, motor location: 1 +++
+++ Event 1, time: 11, motor location: 2 +++
### Dead loop: go back to event 0 ###

```
